var logoSvg = `
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" width="1.0055in" height="0.450874in" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 1000 448">
 <defs>
    <linearGradient id="id0" gradientUnits="userSpaceOnUse" x1="7.87024" y1="418.807" x2="1000.02" y2="418.807">
     <stop offset="0" stop-color="#06A190"/>
     <stop offset="0.501961" stop-color="#373435"/>
     <stop offset="1" stop-color="#06A190"/>
    </linearGradient>
 </defs>
 <g id="Layer_x0020_1">
  <metadata id="CorelCorpID_0Corel-Layer"/>
  <g id="_404713272">
   <path fill="#06A190" fill-rule="nonzero" stroke="#06A190" stroke-width="10.9596" d="M92 276l0 -1c-5,0 -10,-1 -15,-3 -5,-1 -9,-3 -14,-5 -5,-2 -9,-5 -13,-7 -4,-3 -8,-5 -12,-9 -5,-5 -8,-9 -10,-13 -3,-4 -4,-8 -5,-13 -1,-5 0,-10 1,-16 1,-4 3,-8 6,-10 3,-3 5,-5 8,-7 3,-2 6,-3 8,-4 3,-1 5,-1 7,-2l148 -18 0 -1c0,-4 -1,-8 -2,-12 -1,-4 -2,-8 -3,-10 -1,-3 -3,-6 -3,-8 -1,-3 -2,-4 -3,-6 -5,-9 -11,-16 -18,-23 -7,-7 -15,-13 -23,-17 -9,-5 -18,-8 -27,-9 -10,-2 -19,-2 -30,-1 -13,1 -26,5 -37,12 -12,6 -21,15 -29,25 -8,10 -14,21 -18,34 -4,13 -5,25 -3,38 1,11 5,22 9,31 5,10 11,18 19,26 8,8 17,14 26,19 10,5 21,8 32,9l-1 0 0 0zm-68 -153c4,-5 8,-10 13,-16 5,-5 10,-9 17,-13 6,-3 12,-6 18,-8 6,-3 13,-4 20,-5 8,-1 15,-1 22,0 8,1 14,3 21,5 7,3 13,5 19,9 6,4 12,8 17,13 3,3 4,5 6,8 2,3 4,6 5,10 1,4 3,8 3,11 0,4 0,8 -1,12 -1,4 -3,8 -6,11 -3,3 -5,5 -9,8 -3,2 -6,3 -8,4 -3,1 -5,1 -6,2l-98 12c-2,0 -5,0 -7,0 -3,0 -6,0 -10,-2 -4,-1 -8,-3 -11,-5 -4,-3 -6,-5 -9,-9 -3,-4 -4,-9 -5,-13 0,-5 0,-9 0,-13 1,-4 2,-8 3,-10 1,-3 3,-6 4,-8l1 0 -1 0z"/>
   <path fill="#06A190" fill-rule="nonzero" stroke="#06A190" stroke-width="10.9596" d="M348 275l2 0 -45 -80c-2,-4 -3,-9 -4,-13 -1,-4 -1,-8 -1,-11 0,-3 0,-6 1,-10 0,-3 1,-5 3,-8l39 -71 -1 0 -35 63c-1,2 -3,3 -4,5 -1,1 -3,3 -5,4 -2,1 -4,2 -6,3 -3,0 -5,1 -8,1 -3,0 -5,0 -8,-1 -3,0 -5,-1 -6,-3 -2,-1 -4,-3 -5,-4 -1,-1 -3,-3 -4,-5l-35 -63 -1 0 33 60c0,0 0,0 0,0 0,0 0,0 0,0l4 6c1,3 3,5 3,9 1,3 1,7 1,12 0,4 0,9 -1,14 -1,5 -3,10 -5,15l-41 75 1 0 41 -75c1,-2 2,-3 4,-5 1,-1 3,-3 5,-3 2,-1 4,-2 6,-3 3,0 5,-1 8,-1 3,0 5,0 8,1 3,0 5,1 6,3 2,1 4,2 5,3 1,1 3,3 4,5l41 75 0 0z"/>
   <path fill="#373435" fill-rule="nonzero" stroke="#373435" stroke-width="10.9596" d="M866 175c-7,0 -14,-1 -20,-4 -6,-3 -12,-6 -17,-10 -5,-5 -8,-10 -11,-16 -3,-6 -4,-13 -4,-19l0 -22c0,-7 1,-13 4,-19 3,-6 6,-11 11,-16 5,-5 10,-8 17,-10 6,-3 13,-4 20,-4l61 0c8,0 16,2 23,5 8,3 14,8 20,13 5,5 10,12 13,19 3,8 5,15 5,23 0,8 -1,16 -5,23 -3,8 -8,14 -13,19 -5,5 -13,10 -20,13 -8,3 -16,5 -24,5l-1 0 -60 0 0 -1 0 0zm122 134l1 -1 -92 -121c0,0 0,0 0,-1 0,0 0,-1 0,-2 0,0 0,-1 0,-2 0,0 0,-1 0,-2 0,-1 0,-1 1,-2 0,0 1,-1 1,-1 0,0 1,0 2,0 0,0 1,0 2,0l24 0c9,0 17,-2 24,-5 8,-3 14,-8 20,-13 6,-5 10,-13 13,-20 3,-8 5,-15 5,-23 0,-8 -2,-16 -5,-23 -3,-8 -8,-14 -14,-20 -6,-6 -13,-10 -21,-14 -8,-3 -16,-5 -24,-5l-114 0 0 256 2 0 0 -83c0,-7 1,-13 4,-19 3,-6 6,-11 11,-16 5,-5 10,-8 17,-10 6,-3 13,-4 20,-4l8 0c1,0 1,0 3,0 1,0 2,0 3,0 1,0 3,0 3,1 1,0 2,0 3,1 1,0 2,1 3,2 1,0 2,1 3,2 1,1 1,1 1,1 0,0 1,1 3,3l92 122 0 -1 0 -1zm-391 0c21,-58 43,-116 63,-174 10,-31 53,-23 60,0l68 174 2 0 -101 -260 -94 260 1 0 0 0 0 0zm-15 -67l0 5c0,8 -2,16 -5,23 -3,8 -8,14 -13,19 -5,5 -13,10 -20,13 -8,3 -26,5 -35,5l-59 0c-7,0 -13,-1 -20,-4 -6,-3 -12,-6 -16,-10 -5,-5 -8,-10 -11,-16 -3,-6 -4,-13 -4,-19l0 -26c0,-7 1,-13 4,-19 3,-6 6,-12 11,-16 5,-5 10,-8 16,-11 6,-3 13,-4 20,-4l60 0 0 0c25,1 57,14 66,37 3,8 5,15 5,23l0 0 0 0zm-132 -62c-7,0 -13,-1 -20,-4 -6,-3 -12,-6 -16,-10 -5,-5 -8,-10 -11,-16 -3,-6 -4,-13 -4,-19l0 -28c0,-7 1,-13 4,-19 3,-6 6,-11 11,-16 5,-5 10,-8 16,-10 6,-3 13,-4 20,-4l49 0c8,0 16,2 23,5 8,3 14,8 20,13 5,5 10,12 13,19 3,8 5,15 5,23l0 6c0,4 0,8 -1,12 -1,4 -2,8 -4,11 -8,18 -14,32 -34,36 -4,1 -8,1 -12,1l-60 0 0 -1 0 0zm60 129c8,0 27,-2 35,-5 8,-3 14,-8 20,-13 6,-5 10,-13 13,-20 3,-8 5,-15 5,-23l0 -5c0,-5 0,-10 -2,-16 -1,-5 -3,-10 -6,-14 -12,-20 -37,-24 -38,-31 0,-1 0,-2 1,-3 6,-12 18,-32 21,-43 1,-5 2,-10 2,-15l0 -6c0,-8 -1,-16 -5,-23 -3,-8 -8,-14 -13,-20 -6,-5 -13,-10 -20,-13 -8,-3 -16,-5 -24,-5l-101 0c0,3 0,14 0,35 0,21 0,52 0,93 0,41 0,72 0,93 0,21 0,33 0,35l112 0 0 0 0 -1z"/>
   <path fill="url(#id0)" fill-rule="nonzero" d="M23 390c5,0 9,1 11,3 3,2 4,5 4,10l0 3c0,3 0,5 -2,8 -1,2 -3,3 -6,4 6,1 9,5 9,12l0 5c0,4 -1,8 -4,10 -3,3 -6,3 -12,3l-16 0 0 -57 15 0 0 0 0 0zm-2 24c3,0 5,0 7,-2 1,-1 3,-3 3,-6l0 -3c0,-3 0,-5 -2,-5 -1,-1 -3,-2 -5,-2l-8 0 0 18 6 0 0 0 0 0zm3 27c3,0 5,0 6,-2 1,-1 2,-3 2,-6l0 -5c0,-3 -1,-5 -3,-6 -1,-1 -4,-2 -8,-2l-6 0 0 21 8 0 0 0 0 -1zm67 6l-7 0 13 -57 11 0 13 57 -8 0 -3 -12 -17 0 -3 12 1 0zm19 -17l-8 -33 -8 33 15 0 0 0 0 0zm72 -40c5,0 9,1 12,3 3,3 4,5 4,10l0 5c0,3 0,5 -2,8 -1,2 -4,3 -6,4 3,1 5,3 6,4 1,2 2,5 2,8l0 9c0,1 0,3 0,4 0,1 0,2 1,3l-8 0c0,-1 -1,-2 -1,-3 0,-1 0,-3 0,-4l0 -9c0,-3 -1,-5 -3,-6 -2,-1 -4,-2 -8,-2l-5 0 0 24 -8 0 0 -57 15 0 0 0 0 0zm-2 27c3,0 5,0 8,-2 1,-1 3,-3 3,-6l0 -5c0,-3 0,-5 -2,-6 -1,-1 -3,-2 -6,-2l-8 0 0 21 5 0 0 0 0 -1zm79 -27c5,0 9,1 12,4 3,3 4,6 4,10l0 5 -8 0 0 -5c0,-5 -3,-8 -8,-8 -3,0 -5,1 -6,3 -1,1 -2,4 -2,6l0 30c0,3 0,5 2,6 1,1 3,3 6,3 5,0 8,-3 8,-8l0 -8 8 0 0 7c0,5 -1,8 -4,10 -3,3 -6,4 -12,4 -5,0 -9,-1 -12,-4 -3,-3 -4,-6 -4,-10l0 -30c0,-5 1,-8 4,-10 3,-3 6,-4 12,-4l0 0zm61 14c0,-5 1,-8 4,-10 3,-3 6,-4 12,-4 5,0 9,1 12,4 3,3 4,6 4,10l0 30c0,5 -1,8 -4,10 -3,3 -6,4 -12,4 -5,0 -9,-1 -12,-4 -3,-3 -4,-6 -4,-10l0 -30zm8 30c0,3 0,5 2,6 1,1 3,3 6,3 5,0 8,-3 8,-8l0 -30c0,-3 0,-5 -2,-6 -1,-1 -3,-3 -6,-3 -3,0 -5,1 -6,3 -1,1 -2,4 -2,6l0 30 0 0 0 0zm86 -43c5,0 9,1 12,4 3,3 4,6 4,10l0 28c0,5 -1,8 -4,10 -3,3 -6,4 -12,4l-16 0 0 -57 16 0 0 0zm0 51c5,0 8,-3 8,-8l0 -30c0,-5 -3,-8 -8,-8l-8 0 0 45 8 0 0 0 0 0zm86 -20l-17 0 0 20 20 0 0 6 -28 0 0 -57 28 0 0 6 -20 0 0 19 17 0 0 5 0 0 0 0zm134 0l-17 0 0 20 20 0 0 6 -28 0 0 -57 28 0 0 6 -20 0 0 19 17 0 0 5 0 0 0 0zm66 -31c5,0 9,1 12,4 3,3 4,6 4,10l0 28c0,5 -1,8 -4,10 -3,3 -6,4 -12,4l-16 0 0 -57 16 0 0 0zm0 51c5,0 8,-3 8,-8l0 -30c0,-5 -3,-8 -8,-8l-8 0 0 45 8 0 0 0 0 0zm70 6l-8 0 0 -57 8 0 0 57zm57 -51l-13 0 0 -6 33 0 0 6 -13 0 0 51 -8 0 0 -51 0 0 0 0zm64 8c0,-5 1,-8 4,-10 3,-3 6,-4 12,-4 5,0 9,1 12,4 3,3 4,6 4,10l0 30c0,5 -1,8 -4,10 -3,3 -6,4 -12,4 -5,0 -9,-1 -12,-4 -3,-3 -4,-6 -4,-10l0 -30zm8 30c0,3 0,5 2,6 1,1 3,3 6,3 5,0 8,-3 8,-8l0 -30c0,-3 0,-5 -2,-6 -1,-1 -3,-3 -6,-3 -3,0 -5,1 -6,3 -1,1 -2,4 -2,6l0 30 0 0 0 0zm85 -43c5,0 9,1 12,3 3,3 4,5 4,10l0 5c0,3 0,5 -2,8 -1,2 -4,3 -6,4 3,1 5,3 6,4 1,2 2,5 2,8l0 9c0,1 0,3 0,4 0,1 0,2 1,3l-8 0c0,-1 -1,-2 -1,-3 0,-1 0,-3 0,-4l0 -9c0,-3 -1,-5 -3,-6 -2,-1 -4,-2 -8,-2l-5 0 0 24 -8 0 0 -57 15 0 0 0 0 0zm-2 27c3,0 5,0 8,-2 1,-1 3,-3 3,-6l0 -5c0,-3 0,-5 -2,-6 -1,-1 -3,-2 -6,-2l-8 0 0 21 5 0 0 0 0 -1z"/>
   <path fill="#373435" d="M20 34c-6,3 -8,14 -3,25 5,10 14,17 21,13 6,-3 8,-14 3,-25 -5,-10 -14,-17 -21,-13zm128 -15c8,1 11,12 9,23 -3,12 -10,19 -18,18 -8,-1 -11,-12 -9,-23 3,-12 10,-19 18,-18zm-67 -19c10,-1 20,11 22,27 2,16 -5,30 -15,31 -10,1 -20,-11 -22,-27 -2,-16 5,-30 15,-31z"/>
  </g>
 </g>
</svg>
`;


var data = {
	ns:"http://www.w3.org/2000/svg",
	skip: false,
	svg: null,
	excel: null,
	perSvg: 50,
	barcode: {
		path: null,
		type: null,
		plain: false,
		row: "A",
		height: [100],
		step:[4],
	},
	logoSvg: Jua(Jua.stringToNode(logoSvg)),
	history:{
		undoHistory:[],
		redoHistory:[],
		getUndo:function(){
			var undoHistory = this.undoHistory;
			this.undoHistory = [];
			this.undoHistory.push(Jua("div[step='5'] div.optAndSvg div.svg-editor-container div.svg-editor-svg-container div > svg").html(),...undoHistory);
		},
		undo:function(){
			if (this.undoHistory[0]) {
			Jua("div[step='5'] div.optAndSvg div.svg-editor-container div.svg-editor-svg-container div > svg").html(this.undoHistory[0]);
			Jua("div[step='5'] div.optAndSvg div.svg-editor-container div.svg-editor-svg-container div > svg").select("#barcode-g").select("g").each(function(t,i){
				data.barcode.height[i] = parseFloat(t.select("rect").attr('height'));
			});
			var redoHistory = this.redoHistory;
			this.redoHistory = [];
			this.redoHistory.push(this.undoHistory[0],...redoHistory);
			var undoHistory = [];
			this.undoHistory.forEach(function(e,i){
				if (i != 0) {
					undoHistory.push(e);
				}
			});
			this.undoHistory = undoHistory;
			if (elements[0]) {
				Jua('#multiple-select').node.checked = false;
			select({target:elements[0]});
			}
			}
		},
		redo:function(){
		if (this.redoHistory[0]) {
			Jua("div[step='5'] div.optAndSvg div.svg-editor-container div.svg-editor-svg-container div > svg").html(this.redoHistory[0]);
			Jua("div[step='5'] div.optAndSvg div.svg-editor-container div.svg-editor-svg-container div > svg").select("#barcode-g").select("g").each(function(t,i){
				data.barcode.height[i] = parseFloat(t.select("rect").attr('height'));
			});
		var undoHistory = this.undoHistory;
			this.undoHistory = [];
			this.undoHistory.push(this.redoHistory[0],...undoHistory);

			var redoHistory = [];
			this.redoHistory.forEach(function(e,i){
				if (i != 0) {
					redoHistory.push(e);
				}
			});
			this.redoHistory = redoHistory;
			if (elements[0]) {
				Jua('#multiple-select').node.checked = false;
			select({target:elements[0]});
			}
		}
		},
	},
	defaults : {
    CODE128 : "Example 1234",
    CODE128A : "EXAMPLE",
    CODE128B : "Example text",
    CODE128C : "12345678",
    EAN13 : "1234567890128",
    EAN8 : "12345670",
    UPC : "123456789999",
    CODE39 : "EXAMPLE TEXT",
    ITF14 : "10012345000017",
    ITF : "123456",
    MSI : "123456",
    MSI10 : "123456",
    MSI11 : "123456",
    MSI1010 : "123456",
    MSI1110 : "123456",
    pharmacode : "1234",
    qrcode: "Example 1234",
},
};

var overlay = {
	node: Jua(".overlay"),
	show:function(){
		Jua(".overlay").show("flex");
	},
	hide:function(){
		Jua(".overlay").hide();
	}
};

function get(number,type = data.barcode.type,height = data.barcode.height){
	var defaultPlainHeight = {
		CODE128 : [100],
    CODE128A : [100],
    CODE128B : [100],
    CODE128C : [100],
    EAN13 : [100,100,100,100,100],
    EAN8 : [100,100,100,100,100],
    UPC : [100,100,100,100,100],
    CODE39 : [100],
    ITF14 : [100],
    ITF : [100],
    MSI : [100],
    MSI10 : [100],
    MSI11 : [100],
    MSI1010 : [100],
    MSI1110 : [100],
    pharmacode : [100],
    qrcode: null,
	};

	if (data.barcode.plain) {
		height = defaultPlainHeight[type];
	};

	var svg = Jua("<svg>",data.ns);
	data.barcode.height = height;
if (type == "qrcode") {
	svg = Jua(QRCode.generateSVG(String(number)));
}else{
	JsBarcode(svg.node, number ,{
        "format": type,
       "displayValue": false,
       "background": "#00000000",
       "width": 2,
      "lineColor": "#000000",
      "fontSize": 20,
      "margin": 3,
      "textMargin": 0,
      "valid":function(valid){
        if(valid == false){
        	svg = Jua("<div class='not-valid'>Not Valid</div>");
        }
      }
    });

	function format(svgNode){
	var svg = Jua("<svg>",data.ns);
	svg.attr({
		height: svgNode.attr("height"),
		width: svgNode.attr("width"),
		viewBox: svgNode.attr("viewBox"),
	});

		svg.append(svgNode.child());
	return svg;
	};

if (svg.Jua) {
	svg = format(svg);
}
	if (svg.select && height) {
		svg.select("g").each(function(e,i){
			e.select("rect").attr("height",height[i])
		});
	};

}
if (svg.select && svg.child().length > 1) {
	var g = Jua("<g>",data.ns);
svg.child().each(function(e){
	g.append(e);
})
svg.append(g);
}
if (svg.select && defaultPlainHeight[type] && defaultPlainHeight[type].length == 1) {
	var g = Jua("<g>",data.ns);
	g.append(svg.child());
	svg.append(g);
}
return svg;
};

function plainPreviewBarcode(bool){
	if (bool) {
		data.barcode.plain = true;
		changePreviewBarcode();
	}else{
		data.barcode.plain = false;
		changePreviewBarcode();
	};
}

function changePreviewBarcode(type){
var barcodeType = Jua("#barcode-type").val();
data.barcode.type = barcodeType;

	if (type == 'barcode-type') {
	Jua("#input-number").val(data.defaults[barcodeType]);
};

	var input = Jua("#input-number").val();

var defaultHeight = {
		CODE128 : [100],
    CODE128A : [100],
    CODE128B : [100],
    CODE128C : [100],
    EAN13 : [110,100,110,100,110],
    EAN8 : [110,100,110,100,110],
    UPC : [110,100,110,100,110],
    CODE39 : [100],
    ITF14 : [100],
    ITF : [100],
    MSI : [100],
    MSI10 : [100],
    MSI11 : [100],
    MSI1010 : [100],
    MSI1110 : [100],
    pharmacode : [100],
    qrcode: null,
	};


	var code = get(input,barcodeType,defaultHeight[barcodeType]);


Jua(".barcode-preview").html(" ");
Jua(".barcode-preview").append(code);

if (barcodeType == "qrcode") {
		Jua("#plain-preview-barcode").parent().hide();
	}else{
			Jua("#plain-preview-barcode").parent().show();
	};

};

function context(e,options){
	e.preventDefault();
	if (Jua(".context-menu").child().node) {
		Jua(".context-menu").child().remove();
	}
for (let context in options) {
		var div = Jua("<div>");
		div.attr("class","context-menu-option");
		div.html(context);
		div.click(options[context]);
		Jua(".context-menu").append(div);
};
		Jua(".context-menu").class({
			top: e.pageY+"px",
			left: e.pageX+"px",
			display: "flex",
		});
};

Jua(document).click(removeContext);
function removeContext(e){
					Jua(".context-menu").hide();
};

window.onload = function(){
Jua(".preview").zoom();
		changePreviewBarcode();
	overlay.hide();
	Jua(".barcode-preview").on("contextmenu",function(){
		context(event,{
		Download: function(){
   		var svg = Jua('.barcode-preview').child().clone();
   		svg.attr({
   			"xmlns":data.ns,
   			"xmlns:xlink":data.ns,
   			"xml:space":"preserve",
   		});
   		svg.class({
			"shape-rendering":"geometricPrecision",
   		"text-rendering":"geometricPrecision",
   		"image-rendering":"optimizeQuality",
   		"fill-rule":"evenodd",
   		"clip-rule":"evenodd",
   		});
      Jua.download(Jua('#barcode-type').val()+'.svg',Jua.formatHTML(svg.node.outerHTML));
      },
   });
	})
};

function next(step){
	Jua("div[step]").hide();
			if (step == "skip") {
				step = 2;
				data.skip = true;
			}

			if(step == 6){
				overlay.show();
				Jua("#labels-page-svg-input").val(data.excel.rows.length);
				data.perSvg = data.excel.rows.length;
				setTimeout(function() {create(data.excel.rows);overlay.hide();}, 1000);
			}


	if (step == 4) {
		if (data.skip) {
			data.barcode.path = null;
			next(5);
			return;
		}
		for (var i = 0; i < data.svg.paths.length; i++) {
			path = data.svg.paths[i];
			var svg = Jua("<svg>",data.ns);
			svg.attr({
				'xmlns':"http://www.w3.org/2000/svg",
				'xml:space':"preserve",
				'shape-rendering':"geometricPrecision",
				'text-rendering':"geometricPrecision",
				'image-rendering':"optimizeQuality",
				'fill-rule':"evenodd",
				'clip-rule':"evenodd",
				'xmlns:xlink':"http://www.w3.org/1999/xlink",
			})
			svg.append(path);
			Jua("div[step='4']").append(svg);
			svg.attr({
				height: data.svg.original.attr("height"),
				width: data.svg.original.attr("width"),
				viewBox: data.svg.original.attr("viewBox"),
				cursor:"pointer",
			});
			svg.class({
				background:"white",
				margin:"10px",
			});
			svg.click(function(){
				data.barcode.path = Jua(this).select("path").attr("id");
				next(5);
			});
			if (data.svg.paths.length == 1) {
				data.barcode.path = path.attr("id");
				next(5);
			}
		}
		};
		if (step == 5) {
			Jua('.nav-bar').hide();
			var table = Jua(".excel-preview table");
			for(let row in data.excel.rows[0]){
				var tr = Jua("<tr>");
				var rowName = Jua("<td>");
				var rowValue = Jua("<td>");
				rowName.html(row);
				rowValue.html(data.excel.rows[0][row]);
				tr.append([rowName,rowValue]);
				table.append(tr);
				tr.click(function(){
					setToSelection('{{'+row+'}}');
				});
			};
			var dividers = {
    			CODE128 : 1,
    			CODE128A : 1,
    			CODE128B : 1,
    			CODE128C : 1,
    			EAN13 : 3,
    			EAN8 : 2,
    			UPC : 4,
    			CODE39 : 1,
    			ITF14 : 1,
    			ITF : 1,
    			MSI : 1,
    			MSI10 : 1,
    			MSI11 : 1,
    			MSI1010 : 1,
    			MSI1110 : 1,
    			pharmacode : 1,
    			qrcode: 1,
				};
				var letters = ["A","B","C","D"];
			var rowBar = Jua("#row-barcode-number");
			for (var i = 0; i < dividers[data.barcode.type]; i++) {
				var div = Jua("<div>");
				div.html("{{"+letters[i].toLowerCase()+"}}");
				div.click(function(){
					setToSelection(Jua(this).html());
				});
				rowBar.append(div);
			};

			overlay.show();
	Jua("div[step='4']").html(" ");
			Jua(".svg-editor-svg-container div").append(data.svg.original);
			Jua(".svg-editor-svg-container").zoom();
		Jua("div[step='"+5+"']").show();
			setTimeout(function() {
				Jua(".svg-editor-svg-container div svg").node.scrollIntoView();
				Jua(".svg-editor-svg-container div svg").click(select);

				Jua(".svg-editor-svg-container div svg").mousedown(function(e){
					window.NodeMouseDown = e.target;
					var func = function(e){
						Jua(document).removeOn("onmouseup",func,false);
						Jua(window.NodeMouseDown).class("outline","none");
					};
					Jua(e.target).class("outline","dashed "+(20/new WebKitCSSMatrix(Jua("jua-zoomer").class("transform")).a)+"px blue");
					Jua(document).mouseup(func,false);				
				});

			fit(Jua(".svg-editor-svg-container div svg"),get(parseInt(data.excel.rows[0][data.barcode.row])),data.barcode.path);
			}, 300);
		}



if (step != 5) {
	overlay.show();
	setTimeout(function() {
		Jua("div[step='"+step+"']").show();
			overlay.hide();
	},200);
};
}

function fit(svg,barcode,pathId){
	var barcode1 = barcode;
	Jua("body").append(barcode1);
	var path = svg.select("#"+pathId);
	if (!data.skip) {
		var PathBBox = path.node.getBBox();
	}
	var barcode = barcode.select("g")[0];
		setTimeout(function() {
	barcode.attr("id","barcode-g");
	barcode.select("*").attr("id","barcode");
	var BarcodeBBox = barcode.node.getBBox();
	data.barcode.PathBBox = PathBBox;
if (!data.skip) {
	barcode.class("transform","scale("+(PathBBox.width/BarcodeBBox.width)+","+(PathBBox.height/BarcodeBBox.height)+") translate("+(PathBBox.x/(PathBBox.width/BarcodeBBox.width))+"px,"+(PathBBox.y/(PathBBox.height/BarcodeBBox.height))+"px)");
	}else{
		barcode.class("transform","scale(0,0) translate(0px,0px)");
	}
	svg.append(barcode);

	svg.select("text").each(function(e){
		e.attr("data-width",e.node.getBBox().width);
		if (e.hasAttr("font-family")) {
			e.attr("font-family","'"+e.attr("font-family")+"'");
		};
	});

	barcode1.remove();
	setTimeout(function() {
		data.history.getUndo();
	}, 10);
		}, 300);
			overlay.hide();
};

function uploadSvg(svg,file){
	overlay.show();
	data.svg = {
		fileName: file.name,
		original:Jua(Jua.stringToNode(svg)),
	};
	
	data.svg.defs = data.svg.original.select("defs").clone();
	data.svg.original.select("defs").remove();
	data.svg.original.select("*").each(function(e){
		e.attr("id",Jua.randomId());
		e.attr("random",true);
	});
	data.svg.original.append(data.svg.defs);

	var viewBox = data.svg.original.attr("viewBox").replace(/  +/g, ' ').split(" ");
	data.svg.height = parseFloat(viewBox[3]);
	data.svg.width = parseFloat(viewBox[2]);
	var cloned = data.svg.original.clone();
	var svg = Jua("<svg>",data.ns);
	svg.attr({
		height: cloned.attr("height"),
		width: cloned.attr("width"),
		viewBox: cloned.attr("viewBox"),
	});
	cloned.select("defs").remove();
	svg.append(cloned.child());

	var svgOnBody = data.svg.original.clone();
	Jua("body").append(svgOnBody);
	svgOnBody.hide();

	data.svg.edited = svg;
	data.svg.paths = [];

	svg.select("path").each(function(e){
		e.attr("fill",svgOnBody.select("#"+e.attr("id")).class("fill"));
		e.attr("fill-opacity",svgOnBody.select("#"+e.attr("id")).class("fill-opacity"));
		e.attr("stroke-width",svgOnBody.select("#"+e.attr("id")).class("stroke-width"));
		e.attr("stroke",svgOnBody.select("#"+e.attr("id")).class("stroke"));
		data.svg.paths.push(e);
	});

	if (svg.skip) {
		data.svg.paths = [svg.select('path[data-barcode-skip=true]')];
	};
	cloned.append(data.svg.defs);
	svgOnBody.remove();
	next(3);
};

function uploadExcel(binary,file){
	overlay.show();
	data.excel = {
		fileName: file.name,
		binary: binary,
		rows:null,
	};
	var excel = XLSX.read(binary,{
		type:"binary",
	});
	data.excel.worksheet = excel;
	data.excel.rows = XLSX.utils.sheet_to_json(excel.Sheets[excel.SheetNames[0]], {header: "A"});
	next(4);
};

var elements = [];

function select(e){
	var target = Jua(e.target);
	if (target.tagName().toLowerCase() == "svg") {return;}

		show();

	switch(target.tagName().toLowerCase()){
		case 'text': case 'tspan':
		show("text");
		break;

		case 'g':
		if (target.attr("id") == "barcode") {
			show("barcode");
			target = Jua("#barcode-g");
		}
		break;

		case 'rect':
		if (target.attr("id") == "barcode") {
			show("barcode");
			target = Jua("#barcode-g");
		}
		break;
	};

	if (!Jua('#multiple-select').node.checked) {
		elements = [];
	}else{
	if (target.tagName().toLowerCase() != "text") {return;}
	}

	if (!elements.includes(target.tagName().toLowerCase()+"#"+target.attr("id"))) {
		elements.push(target.tagName().toLowerCase()+"#"+target.attr("id"));
	};
	_elements = [];
	elements.forEach(function(e){
		_elements.push(e.substring(0,e.search("#")));
	});

	Jua(".selected-item-shower").html(_elements[0]+"("+_elements.length+")");

	function show(type){
			setTimeout(function() {
						if (type == 'text') {
			var align = {
				start: "left",
				middle: "center",
				end: "right",
			}
			Jua("#row-edit-text input").val(target.text());
			if (target.class("letter-spacing") == "normal") {
				Jua("#row-text-space input").val('0');
			}else{
				Jua("#row-text-space input").val(String(parseFloat(target.class("letter-spacing"))));
			}

			Jua("#row-align-text").select(".slider-align").attr("align",align[target.class("text-anchor")]);

		};

		Jua(".opt-container .opt-row").hide();
		var ids = ["row-selected-item","row-barcode-number","next-or-preview"];
		var types = {
			text: ["row-edit-text","row-text-space","row-group-text","row-align-text","row-shrink-text"],
			barcode: ["row-customize-barcode"],
		};

		if (types[type]) {
				if (elements.length > 1 && type == "text") {
					ids.push("row-group-text");
				}
				if (elements.length == 1) {
					ids.push(...types[type]);
				}
		}

		for (var i = 0; i < ids.length; i++) {
			Jua("#"+ids[i]).show("flex");
		}
			}, 10);
	};

};

function removeEmptyGroups(){
Jua("body > div:nth-child(6) > div > div.svg-editor-container svg").select("g").each(function(e){
	if (!e.child().node) {
		e.remove();
	};
})
};

function set(type,value){
	switch(type){
		case 'edit-text':
			Jua(elements[0]).html(value);
				data.history.getUndo();
		break;

		case 'text-space':
			Jua(elements[0]).attr("letter-spacing",value);
				data.history.getUndo();
		break;

		case 'align':
		var align = {
				start: "left",
				middle: "center",
				end: "right",
			}
		var anchorOld = align[Jua(elements[0]).class("text-anchor")];
		var anchorNew = align[value];
		var BBox = Jua(elements[0]).node.getBBox();

		if (anchorOld == "left" && anchorNew == "center") {
				Jua(elements[0]).attr("x", BBox.x + (BBox.width/2) );
		};

		if (anchorOld == "left" && anchorNew == "right") {
				Jua(elements[0]).attr("x", BBox.x + BBox.width );
		};

		if (anchorOld == "center" && anchorNew == "left") {
				Jua(elements[0]).attr("x", BBox.x );
		};

		if (anchorOld == "center" && anchorNew == "right") {
				Jua(elements[0]).attr("x", BBox.x + BBox.width );
		};

		if (anchorOld == "right" && anchorNew == "left") {
				Jua(elements[0]).attr("x", BBox.x);
		};

		if (anchorOld == "right" && anchorNew == "center") {
				Jua(elements[0]).attr("x", BBox.x + (BBox.width/2));
		};

		Jua(elements[0]).attr("text-anchor",value);
		Jua('.switch.abs .slider-align').attr('align',align[value]);
			setTimeout(function() {
				data.history.getUndo();
			}, 10);
		break;

		case 'group':
		if (elements.length > 1) {
			var text0 = Jua(elements[0]);
			var text1 = Jua(elements[1]);
		text0.attr("letter-spacing",(Offest(text1).x - Offest(text0).x)  - Offest(text0).width);
		for (var i = 1; i < elements.length; i++) {
			text0.html(Jua(elements[i]).html(),"+");
			Jua(elements[i]).remove();
		};
		Jua("#multiple-select").node.checked = false;
		select({target:text0,});
		removeEmptyGroups();
		};
			setTimeout(function() {
				data.history.getUndo();
			}, 10);
		break;

		case 'shrink-text':
				data.history.getUndo();
		var elem = Jua(elements[0]);
		elem.node.scrollIntoViewIfNeeded();
		var BBox = Jua(elem).node.getBoundingClientRect();
		var body = Jua.body;
		var resizer = Jua("<div>");
		var overlay = Jua("<canvas>");
		var finish  = Jua("<button.finish-editing>");
		finish.html('Finish Editing');
		overlay.class({
			position: 'fixed',
			left: '0px',
			right: '0px',
			top: '0px',
			bottom: "0px",
			height: "100%",
			width: "100%",
			'z-index': 9999999999999999999999999999999,
		});
		body.append([overlay,resizer,finish]);
		overlay.node.height = window.innerHeight;
		overlay.node.width = window.innerWidth;
		var ctx = overlay.ctx();
		ctx.fillStyle = " #000000bf";
		ctx.fillRect(0,0,window.innerWidth,window.innerHeight);
		ctx.clearRect(BBox.x,BBox.y,BBox.width,BBox.height);
		var ms = (parseFloat(elem.attr("shrink-scale")) || 1);
		resizer.class({
			position: 'fixed',
			border: 'dashed 4px red',
			left: (BBox.x - 8)+"px",
			top: (BBox.y - 4)+"px",
			height: BBox.height+"px",
			width: (BBox.width * ms)+"px",
			'z-index': 99999999999999999999999999999999,
		});

				finish.class({
					top: (BBox.y + BBox.height + 20) + "px",
					left: ((BBox.x + BBox.width/2) - ((108.062+30)/2)) + "px",
				});

		switch(elem.class('text-anchor')){
			case 'middle':
			resizer.class("left",((BBox.x - 4)+((BBox.width - (BBox.width * ms))/2)) + "px");
			break;
			case 'end':
			resizer.class("left",((BBox.x - 4)+(BBox.width - (BBox.width * ms))) + "px");
			break;
		}

		resizeByAlign(resizer,elem,elem.class('text-anchor'));
		finish.click(function(){
			elem.attr("shrink-scale",(parseFloat(resizer.class("width"))-4)/(BBox.width-4));
			resizer.remove();
			overlay.remove();
			finish.remove();
		data.history.getUndo();
		});
		break;

		case 'c-barcode':
				data.history.getUndo();
		var elem = Jua(elements[0]);
		elem.node.scrollIntoViewIfNeeded();
		var BBox = Jua(elem).node.getBoundingClientRect();
		var body = Jua.body;
		var resizers = [];
		var resizers = [];
		var overlay = Jua("<canvas>");
		var finish  = Jua("<button.finish-editing>");
		finish.html('Finish Editing');
		overlay.class({
			position: 'fixed',
			left: '0px',
			right: '0px',
			top: '0px',
			bottom: "0px",
			height: "100%",
			width: "100%",
			'z-index': 9999999999999999999999999999999,
		});
		body.append([overlay,finish]);
		overlay.node.height = window.innerHeight;
		overlay.node.width = window.innerWidth;
		var ctx = overlay.ctx();
		ctx.fillStyle = " #000000bf";
		ctx.fillRect(0,0,window.innerWidth,window.innerHeight);
		var add = 20;
		ctx.clearRect(BBox.x -(add/2),BBox.y -(add/2),BBox.width + (add),BBox.height + (add));
				
				finish.class({
					top: (BBox.y + BBox.height + 20) + "px",
					left: ((BBox.x + BBox.width/2) - ((108.062+30)/2)) + "px",
				});

		elem.select('g').each(function(t,i){
			var newDiv = Jua("<div>");
			var BBox = t.node.getBoundingClientRect();
			newDiv.class({
				position: "fixed",
				top: BBox.y+"px",
				left: BBox.x+"px",
				height: BBox.height+"px",
				width: BBox.width+"px",
				background: '#ff000075',
				cursor: 'pointer',
				outline: 'solid 1.5px black',
			});
			newDiv.attr({
				id: "resizer-barcode",
				index: i,
			});
			newDiv.attr("data-height",BBox.height);
			body.append(newDiv);
			resizers.push(newDiv);
			newDiv.click(function(){
			Jua("#resizer-barcode").attr("selected",false);
			Jua("#resizer-barcode").class("background","#ff000075");
			Jua(this).class("background","#35ff0080");
			Jua(this).attr("selected",true);
		});
		});
		resizers[0].click();
		elem.attr("display","none");
		function downKey(e){
			var elem = Jua("#resizer-barcode[selected=true]");

			if (e.key == "ArrowUp") {
				var height1 = parseFloat(elem.class("height")) - 1;
			}
			if (e.key == "ArrowDown") {
				var height1 = parseFloat(elem.class("height")) + 1;
			}

			elem.class("height",height1+"px");
		};

		Jua(document).on("keydown",downKey,true);

		finish.click(function(){
		Jua(document).removeOn("keydown",downKey,true);
		elem.removeAttr("display");
		elem.select('g').each(function(t,i){
			var height = parseFloat(t.select('rect')[0].attr("height")) * (parseFloat(resizers[i].height()) / parseFloat(resizers[i].attr("data-height")));
			data.barcode.height[i] = height;
			t.select('rect').attr("height",height);
		});
		overlay.remove();
		finish.remove();
		Jua(resizers).remove();
		data.history.getUndo();
		});

		break;

	};
};

			function Offest(elem,obj  = {
					height: 0,
					width: 0,
					x: 0,
					y: 0,
				}){
				var elem = Jua(elem);
				var bbox = elem.node.getBBox();

				if (elem.parent().tagName() == "g") {
					var matrix = new WebKitCSSMatrix(elem.parent().class("transform"));
					var PBBox = elem.parent().node.getBBox();
					if (
						matrix.a == 1
						&&
						matrix.b == 0
						&&
						matrix.c == 0
						&&
						matrix.d == 1
						&&
						matrix.e == 0
						&&
						matrix.f == 0
						) {
						return elem.node.getBBox();
					}else{
						if (PBBox.height != bbox.height && PBBox.width != bbox.width) {
						return elem.node.getBBox();
						}
					}

				}

					var matrix = new WebKitCSSMatrix(elem.parent().class("transform"));

					obj.height = bbox.height * matrix.d;
					obj.width = bbox.width * matrix.a;
					obj.x = bbox.x + matrix.e;
					obj.y = bbox.y + matrix.f;

					return obj;
			};


window.onkeydown = function(e){
	if (e.ctrlKey && e.key.toLowerCase() == "z") {e.preventDefault(); data.history.undo();};
	if (e.ctrlKey && e.key.toLowerCase() == "y") {e.preventDefault(); data.history.redo();};
}

function resizeByAlign(resizer,elem,align = 'start'){
	var elem = Jua(elem);
	var resizer = Jua(resizer);
	var scale = parseFloat(scale);
	var defaultCur = 'default';

	switch(align){
		case 'start':
		resizer.class("border-right-color","#03be7a");
		resizer.mousemove(function(e){
			var x = this.offsetLeft + this.offsetWidth - e.pageX;
			if (x < 5) {
				Jua(this).class("cursor","e-resize");
			}else{
				Jua(this).class("cursor",defaultCur);
			}
		});
		resizer.mousedown(function(e){
			var x = this.offsetLeft + this.offsetWidth - e.pageX;
			var l = this.offsetLeft;
			var _this = this;
			if (x < 5) {
				Jua(document).mousemove(move);
				Jua(document).mouseup(up);
				function move(e){
				e.preventDefault();
				Jua(_this).class({
					width: (e.pageX - l - 6)+"px",
				});
				};
				function up(e){
				Jua(document).removeOn('mousemove',move);
				Jua(document).removeOn('mouseup',up);
				};
			};
		});
		break;

		case 'middle':
		resizer.class("border-left-color","#03be7a");
		resizer.class("border-right-color","#03be7a");

		resizer.mousemove(function(e){
			var x = this.offsetLeft + this.offsetWidth - e.pageX;
			if (x < 5 || x > this.offsetWidth-5) {
				Jua(this).class("cursor","e-resize");
			}else{
				Jua(this).class("cursor",defaultCur);
			}
		});
		resizer.mousedown(function(e){
			var x = this.offsetLeft + this.offsetWidth - e.pageX;
			var l = this.offsetLeft;
			var w = this.offsetWidth;
			var _this = this;
			if (x < 5) {
				Jua(document).mousemove(move);
				Jua(document).mouseup(up);
				function move(e){
				e.preventDefault();
				if ((e.pageX - l - 6) > 2) {
					Jua(_this).class({
					width: (e.pageX - l - 6)+"px",
					left: ((l+(w/2) - 4) - ((e.pageX - l - 6)/2)) +"px",
				});
				}
				};
				function up(e){
				Jua(document).removeOn('mousemove',move);
				Jua(document).removeOn('mouseup',up);
				};
			};
			if (x > this.offsetWidth-5 ) {
				Jua(document).mousemove(move);
				Jua(document).mouseup(up);
				function move(e){
				e.preventDefault();
				if (((l+w) - e.pageX - 8) > 2) {
					Jua(_this).class({
					width: ((l+w) - e.pageX - 8)+"px",
					left: ((l+(w/2) -  ((l+w) - e.pageX)/2))+"px",
				});
				}
				};
				function up(e){
				Jua(document).removeOn('mousemove',move);
				Jua(document).removeOn('mouseup',up);
				};
			}
		});
		break;

		case 'end':
		resizer.class("border-left-color","#03be7a");
		resizer.mousemove(function(e){
			var x = this.offsetLeft + this.offsetWidth - e.pageX;
			if (x > this.offsetWidth-5) {
				Jua(this).class("cursor","e-resize");
			}else{
				Jua(this).class("cursor",defaultCur);
			}
		});
		resizer.mousedown(function(e){
			var x = this.offsetLeft + this.offsetWidth - e.pageX;
			var w = this.offsetWidth;
			var l = this.offsetLeft;
			var _this = this;
			if (x > this.offsetWidth-5) {
				Jua(document).mousemove(move);
				Jua(document).mouseup(up);
				function move(e){
				e.preventDefault();

				if (((l+w) - e.pageX) > 2) {
					Jua(_this).class({
					width: ((l+w) - e.pageX)+"px",
					left: (e.pageX-8)+"px",
				});
				};

				};
				function up(e){
				Jua(document).removeOn('mousemove',move);
				Jua(document).removeOn('mouseup',up);
				};
			};
		});
		break;

	}
};
function setToSelection(word){
    var input = Jua("#edit-text").node;
    var start = input.selectionStart;
    var finish = input.selectionEnd;
    var allText = input.value;
    if (start == finish) {
      start = 0;
      finish = allText.toString().length;
    }
    var sel = allText.substring(start, finish);
    var newText = allText.substring(0, start)+word+allText.substring(finish, allText.length);
    input.value = newText;
    set('edit-text',newText)
};

function getSplitedBarcodeNumber(number){
	number = String(number);
	var returnObj = {};
	var spliter = {
		EAN13:[1,6,6],
		UPC:[1,5,5,1],
		EAN8:[4,4],
	};
	if (data.barcode.type == "UPC" && number.length == 11) {
		number = "0"+number;
	};
	var letters = ["a","b","c","d"];
	if (spliter[data.barcode.type]) {
		var current = number;
		for (var i = 0; i < spliter[data.barcode.type].length; i++) {
			returnObj[letters[i].toLowerCase()] = current.substring(0,spliter[data.barcode.type][i]);
			current = current.substring(spliter[data.barcode.type][i],current.length);
		};
	}else{
		returnObj["a"] = number;
	}
	return returnObj;
};

function compile(excel,filename){
		var div = Jua("<div>");
		var name = Jua("<name>");
		var progress = Jua("<progress>");
		div.append([name,progress]);
		name.html(filename.replaceAll("\n",""));
		if (excel.length != 1) {Jua(".progress-overlay .progress").append(div);}


	if(!excel.length){excel = [excel];};
	if (!data.skip) {
			Jua("div[step='5'] div.optAndSvg div.svg-editor-container div.svg-editor-svg-container div > svg").select("#"+data.barcode.path).remove();
	}
	var svg = Jua("div[step='5'] div.optAndSvg div.svg-editor-container div.svg-editor-svg-container div > svg");
	svg.select("*[random=true]").each(function(e){
		e.removeAttr("id");
		e.removeAttr("random");
	});

	var svgs = [];
	excel.forEach(function(e){
		var rows = e;
		var splited = getSplitedBarcodeNumber(e[data.barcode.row]);
		for (let row in splited) {
			rows[row] = splited[row];
		};
		var svgN = svg.clone();
	if (!data.skip && Jua("div[step='5'] div.optAndSvg div.svg-editor-container div.svg-editor-svg-container div").select("#barcode-g").node) {
		var original = svgN.select("#barcode-g");
		var replace = get(e[data.barcode.row]);
		Jua("div.tester#tester").append(replace);
		var BarcodeBBox = replace.node.getBBox();
		var PathBBox = data.barcode.PathBBox;
		var g = Jua("<g>",data.ns);
		g.append(replace.child());
		g.attr("transform","scale("+(PathBBox.width/BarcodeBBox.width)+","+(PathBBox.height/BarcodeBBox.height)+") translate("+(PathBBox.x/(PathBBox.width/BarcodeBBox.width))+","+(PathBBox.y/(PathBBox.height/BarcodeBBox.height))+")");
		original.parent().append(g);
		original.remove();
	};
		var compiled = Handlebars.compile(svgN.toString())(rows);
		svgs.push(Jua(Jua.stringToNode(compiled)));
	});
	return [svgs,progress];	
};

function getCompiled(step = true,excel = data.excel.rows,filename = "",isLast = false){
	if (step){
		var compiled = compile(excel,filename);
	}else{
		var compiled = compile(excel[0],filename);
	};
	var progress = compiled[1];
	compiled = compiled[0];

	var svg = Jua("<svg>",data.ns);
	svg.attr({
		'width': "8.26772in",
		'height': "1800in",
		'viewBox': "0 0 8268 1800000",
		'xmlns': "http://www.w3.org/2000/svg",
		'xml:space': "preserve",
		'shape-rendering': "geometricPrecision",
		'text-rendering': "geometricPrecision",
		'image-rendering': "optimizeQuality",
		'fill-rule': "evenodd",
		'clip-rule': "evenodd",
		'xmlns:xlink': "http://www.w3.org/1999/xlink",
	});
	svg.append(data.svg.defs);
	if (!step) {
		svg.attr({
		'width': compiled[0].attr("width"),
		'height': compiled[0].attr("height"),
		'viewBox': compiled[0].attr("viewBox"),
		});
	};

	if (isLast) {
		compiled.push(data.logoSvg);
	};

	var y = 0;
	var x = 0;
	var c = 0;

		for (var i = 0; i < compiled.length; i++) {
			var g = Jua("<g>",data.ns);
			if (compiled.length == i+1 && isLast) {
				g.attr("transform","translate("+0 +","+((y * (data.svg.height + 30))  + data.svg.height) +")");
			}else{
				g.attr("transform","translate("+(x * (data.svg.width + 5))+","+(y * (data.svg.height + 5))+")");
			};

			g.append(compiled[i].child());
			svg.append(g);

			if (x == data.barcode.step[c]-1) {
				c += 1;
				y += 1;
				x = -1;
			};
			if (c == data.barcode.step.length) {
				c = 0
			};
			x++;
		};
		Jua("div#tester.tester").html(" ");
		Jua("div#tester.tester").append(svg);
		

		progress.attr("max",Jua("div#tester.tester").select("text").length);

		Jua("div#tester.tester").select("text").each(function(e,i){
			var scale = parseFloat(e.attr("shrink-scale"));
			var textAnchor = e.attr("text-anchor");
			var BBox = e.node.getBBox();
			if (scale) {
				scale = parseFloat(e.attr("data-width")) * scale;
			}

			switch(textAnchor){
				case 'middle':
					e.attr("x", BBox.x);
				break;

				case 'end':
					e.attr("x", BBox.x);
				break;
			};
			if (BBox.width > scale) {
				strech(e,scale);
			};

			e.attr("text-anchor","start");
			function strech(elem,Wantwidth){
  var BBox = elem.node.getBBox();
  if (textAnchor == "middle") { BBox.x = Number(BBox.x) + (BBox.width/2); };
  if (textAnchor == "end") { BBox.x = Number(BBox.x) + (BBox.width); };
  var matrix = new WebKitCSSMatrix(Jua(elem).class("transform"));
  var width = BBox.width;
  var sx = Wantwidth/width;
  var tx = BBox.x;
  if (textAnchor == "end") { 
  	var width1 = tx + width;
  	var width2 = tx + (width*sx);
  	tx = (width1 - width2) + tx;
  };
  if (textAnchor == "middle") {
  	var width1 = tx + width;
  	var width2 = tx + (width*sx);
  	tx = ((width1 - width2)/2)+ tx;
  };
  e.removeAttr("x");
  elem.attr("transform","matrix("+sx+","+matrix.b+","+matrix.c+","+matrix.d+","+tx+","+matrix.f+")");
}
			e.removeAttr("shrink-scale");
			e.removeAttr("data-width");
			progress.node.value = i+1;
		});

	data.history.undo();
		if (step) {
			return svg.toString();
		}else{
			return svg;
		};
};
function preview(){
	Jua(".preview").show("flex");
	Jua(".preview").click(function(){
		Jua(this).hide();
	});
	Jua(".preview jua-zoomer").class("transform-origin","center center");
	Jua(".preview div").html(" ");
	Jua(".preview div").append(getCompiled(false));
};

function addInput(id){
	var inp = __Jua('<div><input type="number" value="1"><span onclick="this.parentNode.remove();document.querySelector(`#'+id+'`).remove();">X</span></div>');
	
	Jua(".step-preview g").append(inp);	
};


function finish(){
	Jua(".progress-overlay").show("flex");
	if(data.skip){
			Jua("div[step='5'] div.optAndSvg div.svg-editor-container div.svg-editor-svg-container div").select("#barcode-g").node.remove();
	};

		setTimeout(function() {
			if (Jua(".step-preview g").select("input").length) {
				data.barcode.step = [];
	Jua(".step-preview g").select("input").each(function(e){
		data.barcode.step.push(parseInt(e.val()));
	});
	};

		var currentArrayNumberSliced = 0;
		window.svgsCompiled = [];
		var perSvg = data.perSvg;
		var cloop = Math.ceil(data.excel.rows.length/perSvg);
		var whole = Math.ceil(data.excel.rows.length/perSvg);
		var index = 0;
		var fileName = "({{index}}) "+data.svg.fileName.replace(".svg","");
		fileName += " - Ex-bar Editor.svg";
		var progress = Jua(".progress .progress-bar .bar");

		loop();
	function loop(){
		progress.html((index+1)+" of "+whole);
		svgsCompiled.push(
			getCompiled(
				true,
				data.excel.rows.slice(currentArrayNumberSliced, (currentArrayNumberSliced+perSvg > data.excel.rows.length) ? data.excel.rows.length:currentArrayNumberSliced+perSvg ),
				fileName.replace("{{index}}",index+1),
				(cloop - 1) ? false : true,
				));
		currentArrayNumberSliced += perSvg;
		index++;
		cloop--;
		progress.class("width",(((window.svgsCompiled.length+1) / whole) * 100)+"%");
			if (cloop) {
				setTimeout(function() {loop()}, 10);
			}else{
		progress.html("Download Complete ! <a href='javascript:void(0)'>retry</a>");
		progress.class({
			cursor:"pointer",
			color:"white",
			background:"red",
		});
		progress.click(function(){
			loop();
			if (svgsCompiled.length > 1) {
				Jua(".allow-overlay").show("flex");
			};

				function loop(i = 0){
					download(fileName.replace("{{index}}",i+1) , svgsCompiled[i] );
						if (svgsCompiled[i+1]) {loop(i+1);}
				};
		});
		progress.click();
			}
	};
		}, 10);
};

function download(name,svg){
		Jua.download(name,svg);
};

window.addEventListener("keydown",keydown);

function keydown(e){

	var keys = {
		arrow_left: 37,
		arrow_top: 38,
		arrow_right: 39,
		arrow_down: 40,
	};

if (elements[0] && document.activeElement == Jua.body.node) {
	e.preventDefault();

	var element = Jua(elements[0]);
	var ElementBBox = {
		x: parseFloat(element.attr("x")),
		y: parseFloat(element.attr("y")),
	};
	var lesser = 2;

	switch(e.keyCode){
		case keys.arrow_left:
		element.node.setAttribute("x",ElementBBox.x - lesser);
		break;

		case keys.arrow_right:
		element.node.setAttribute("x",ElementBBox.x + lesser);
		break;

		case keys.arrow_top:
		element.node.setAttribute("y",ElementBBox.y - lesser);
		break;

		case keys.arrow_down:
		element.node.setAttribute("y",ElementBBox.y + lesser);
		break;
	};

		};
}


var create = function(rows){
	__Jua('.excel-whole').mousedown(selectCell);
	var widths = [];
	var data = {
            height: 38,
            marginTop: 0,
            marginBottom: 0,
            showAbleHeight: __Jua('.excel-whole').node.offsetHeight,
            parent: __Jua(".excel-whole"),
            values: [],
            scrollElement: __Jua(".excel-whole"),
            getNode: function(v,ind){
            	var tr = __Jua(document.createElement("div"));
            	tr.attr("class","tr");

                for (var i = 0; i < v.length; i++) {
                	var td = __Jua("<div>");
                	td.attr("class","td");
                	td.html(v[i]);
                	if (ind == 0) {
                		td.class("background","linear-gradient(white,#79facb)");
                		td.class("text-align","center");
                	};
                	td.class("width",widths[i]+"px");
                	tr.append(td);
                }

                return __Jua(tr);
            },
          };


          data.values.push(Object.keys(rows[0]));

          var c = [];

          for (var i = 0; i < rows.length; i++) {
          	data.values.push(Object.values(rows[i]));
          };

          data.values.forEach(function(v,g){
          	for (var i = 0; i < v.length; i++) {
          		if (g == 0) {
          			c[i] = [];
          			continue;
          		};
          		c[i].push(String(v[i]));
          	}
          });


          c.forEach(function(e,ind){
          	widths[ind] = (Math.max(...(e.map(el => el.length))) * 8) + 25;
          });

				__Jua.createMany(data);
};

function selectCell(e){
	if(e.target.getAttribute("class") != "td"){
		return;
	};
	var id = Jua.randomId();
	addInput(id);
	var el = __Jua("<div id="+id+" class=selector >");
	var r = e.target.getBoundingClientRect();
	var table = __Jua(".excel-whole");
	var tableRect = table.node.getBoundingClientRect();
	table.append(el);
	var elements = [e.target];
	var elInp = __Jua(".step-preview g").select("input");
	elInp = elInp[elInp.length-1];
	el.class({
		height: (r.height - 2)+"px",
		width: (r.width - 2)+"px",
		top: ((r.top + table.node.scrollTop) - tableRect.top)+"px",
		left: ((r.left + table.node.scrollLeft) - tableRect.left)+"px",
		});

	table.mousemove(move);
	table.mouseup(up);

	function move(e){
		if (!elements.includes(e.target) && e.target.getAttribute("class") == "td") {
			elements.push(e.target);
		};
		el.class("height",((r.height - 2)*elements.length) + "px");
		elInp.val(elements.length);
	};

	function up(){
			table.removeOn("mousemove",move);
			table.removeOn("mouseup",up);
	};

};
